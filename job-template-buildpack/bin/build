#!/usr/bin/env bash

# build: download vom serverless-repo, extract 'job-template' directory to "target directory", pip install von reqirements.txt

# Build script for planqk specific Buildpack
# Autuhor: Robert Brennenstuhl
# Version 0.1
# Created 16.01.2024

set -eo pipefail

echo "---> PlanQK Job Template Buildpack "

[[ -z "$BP_GITLAB_TOKEN" ]] && echo "Variable BP_GITLAB_TOKEN must be set" && exit 1

# create the layer directory
serverless_template_layer="${CNB_LAYERS_DIR}/job-template"
mkdir -p ${serverless_template_layer}

# clone the serverless template repo
git clone https://oauth2:${BP_GITLAB_TOKEN}@gitlab.com/StoneOne/planqk/serverless-template.git "$serverless_template_layer"

# make layer available
echo -e '[types]\nlaunch = true' > "${CNB_LAYERS_DIR}/job-template.toml"

# install python packages
# if [[ -f "requirements.txt" ]]; then
#   pip install -r requirements.txt
# fi

# set default start command
cat <<EOF > "${CNB_LAYERS_DIR}/launch.toml"
[[processes]]
type = "web"
command = ["python", "-m", "app"]
default = true
EOF
