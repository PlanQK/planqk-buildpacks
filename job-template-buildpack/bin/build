#!/usr/bin/env bash

set -eo pipefail

echo "---> PlanQK Job Template Buildpack "

[[ -z "$BP_GITLAB_TOKEN" ]] && echo "Variable BP_GITLAB_TOKEN must be set" && exit 1

# create the layer directory
serverless_template_layer="${CNB_LAYERS_DIR}/job-template"
mkdir -p ${serverless_template_layer}

# clone the serverless template repo
git clone https://oauth2:${BP_GITLAB_TOKEN}@gitlab.com/StoneOne/planqk/serverless-template.git "$serverless_template_layer"

# expose layer
cat <<EOF > "${CNB_LAYERS_DIR}/job-template.toml"
[types]
launch = true
EOF

# install python packages
# if [[ -f "requirements.txt" ]]; then
#   pip install -r requirements.txt
# fi

# expose environment variables
mkdir -p ${serverless_template_layer}/env.launch
echo -n "src.program:run" > "${serverless_template_layer}/env.launch/ENTRY_POINT"
echo -n ":$serverless_template_layer/job-template" > "${serverless_template_layer}/env.launch/PYTHONPATH.append"

# set default start command
cat <<EOF > "${CNB_LAYERS_DIR}/launch.toml"
[[processes]]
type = "web"
command = ["python", "-m", "app"]
default = true
EOF
